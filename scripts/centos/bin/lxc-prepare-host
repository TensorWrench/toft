#!/bin/bash

username=`id -nu`	
if [ ! "$username" = "root" ]; then
	echo "This command has to be run as root!"
	exit 1
fi

# intsall lxc
if [[ ! -f /usr/bin/lxc-ls ]]; then
	(cd /tmp && \
	wget http://lxc.sourceforge.net/download/lxc/lxc-0.7.4.tar.gz && \
	tar zxf lxc-0.7.4.tar.gz && \
	cd lxc-0.7.4 && \
	./configure --prefix=/usr && \
	make && \
	make install)
fi

yum install bridge-utils

if [[ ! `ip link ls dev br0` ]]; then
	brctl addbr br0
	ifconfig br0 192.168.20.1 netmask 255.255.255.0 up
	iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
	sysctl -w net.ipv4.ip_forward=1
fi

if [[ ! -d /cgroup ]]; then
	mkdir -p /cgroup
fi

if [[ ! `mount | grep cgroup` ]]; then
	mount none -t cgroup /cgroup
fi

# allow people to ping this machine
iptables -D FORWARD -j REJECT --reject-with icmp-host-prohibited
iptables -D INPUT -j REJECT --reject-with icmp-host-prohibited
